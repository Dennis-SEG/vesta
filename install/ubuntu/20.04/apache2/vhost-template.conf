# Apache 2.4 Virtual Host Template for Vesta Control Panel
# Backend configuration (behind Nginx)
# Variables: %domain%, %user%, %docroot%

<VirtualHost 127.0.0.1:8080>
    ServerName %domain%
    ServerAlias www.%domain%
    ServerAdmin webmaster@%domain%

    DocumentRoot %docroot%

    <Directory %docroot%>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted

        # PHP 8.3 FPM Configuration
        <IfModule proxy_fcgi_module>
            <FilesMatch \.php$>
                SetHandler "proxy:unix:/run/php/php8.3-fpm-%user%.sock|fcgi://localhost"
            </FilesMatch>
        </IfModule>
    </Directory>

    # Logging
    ErrorLog /var/log/apache2/domains/%domain%.error.log
    CustomLog /var/log/apache2/domains/%domain%.log combined

    # Security headers
    <IfModule headers_module>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
    </IfModule>

    # User and Group
    <IfModule mpm_itk_module>
        AssignUserID %user% %user%
    </IfModule>

    # Mod_ruid2 alternative
    <IfModule ruid2_module>
        RMode config
        RUidGid %user% %user%
        RGroups www-data
    </IfModule>

    # Environment
    SetEnv SERVER_ADMIN "webmaster@%domain%"
</VirtualHost>
