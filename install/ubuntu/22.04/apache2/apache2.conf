# Apache 2.4 Configuration for Vesta Control Panel
# Ubuntu 22.04 LTS
# Optimized for use as backend behind Nginx

# Server Root
ServerRoot "/etc/apache2"

# Mutex and PID
Mutex file:${APACHE_LOCK_DIR} default
PidFile ${APACHE_PID_FILE}

# Timeout and KeepAlive
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# MPM Prefork Configuration (PHP-FPM compatible)
<IfModule mpm_prefork_module>
    StartServers             5
    MinSpareServers          5
    MaxSpareServers         10
    MaxRequestWorkers      150
    MaxConnectionsPerChild   0
</IfModule>

# MPM Event Configuration (if using PHP-FPM)
<IfModule mpm_event_module>
    StartServers             2
    MinSpareThreads         25
    MaxSpareThreads         75
    ThreadLimit             64
    ThreadsPerChild         25
    MaxRequestWorkers      150
    MaxConnectionsPerChild   0
</IfModule>

# Security
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# User and Group
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

# Logging
ErrorLog ${APACHE_LOG_DIR}/error.log
LogLevel warn

# Include module configuration
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Listen on localhost only (behind Nginx)
Listen 127.0.0.1:8080
Listen [::1]:8080

# Global settings
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory /usr/share>
    AllowOverride None
    Require all granted
</Directory>

<Directory /home/*/web/*/public_html>
    Options -Indexes +FollowSymLinks +MultiViews
    AllowOverride All
    Require all granted
</Directory>

# AccessFileName
AccessFileName .htaccess

<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

# MIME types
<IfModule mime_module>
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

# Default charset
AddDefaultCharset UTF-8

# Include other configuration files
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf
