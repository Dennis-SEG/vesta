#!/bin/bash
# Vesta Control Panel - Let's Encrypt SSL Certificate Manager
# Modern ACME v2 Protocol Support
# Supports: HTTP-01 and DNS-01 challenges
# Uses: acme.sh (more reliable than certbot for automation)

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
aliases=$3
email=$4

# Includes
source $VESTA/func/main.sh
source $VESTA/func/domain.sh
source $VESTA/conf/vesta.conf

# Additional argument formatting
if [ -z "$aliases" ]; then
    aliases="www.$domain"
fi
aliases=$(echo "$aliases" | tr ',' ' ')

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DOMAIN [ALIASES] [EMAIL]'
is_format_valid 'user' 'domain'
is_system_enabled "$WEB_SYSTEM" 'WEB_SYSTEM'
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_object_valid 'web' 'DOMAIN' "$domain"
is_object_unsuspended 'web' 'DOMAIN' "$domain"

# Check if SSL already exists
if [ -f "$USER_DATA/ssl/$domain.crt" ]; then
    echo "SSL certificate already exists for $domain"
    echo "Use v-update-letsencrypt-domain to renew"
    exit 1
fi

# Check if acme.sh is installed
if [ ! -f "$VESTA/ssl/acme.sh/acme.sh" ]; then
    echo "Installing acme.sh..."
    mkdir -p $VESTA/ssl/acme.sh
    curl https://get.acme.sh | sh -s email=$email
    ln -s ~/.acme.sh/acme.sh $VESTA/ssl/acme.sh/acme.sh
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Build domain list
domain_list="-d $domain"
for alias in $aliases; do
    domain_list="$domain_list -d $alias"
done

# Set default email if not provided
if [ -z "$email" ]; then
    email="admin@$domain"
fi

# Web root path
web_root="$HOMEDIR/$user/web/$domain/public_html"

# Create .well-known directory for ACME challenge
mkdir -p "$web_root/.well-known/acme-challenge"
chown -R $user:$user "$web_root/.well-known"
chmod 755 "$web_root/.well-known"

echo "Requesting SSL certificate from Let's Encrypt..."
echo "Domain: $domain"
echo "Aliases: $aliases"
echo "Using ACME v2 protocol with HTTP-01 challenge"

# Request certificate using acme.sh with ACME v2
$VESTA/ssl/acme.sh/acme.sh --issue \
    $domain_list \
    -w "$web_root" \
    --server letsencrypt \
    --keylength 2048 \
    --force

if [ $? -eq 0 ]; then
    echo "Certificate issued successfully"

    # Install certificate
    cert_dir="$USER_DATA/ssl"
    mkdir -p "$cert_dir"

    # Copy certificates
    $VESTA/ssl/acme.sh/acme.sh --install-cert -d "$domain" \
        --cert-file "$cert_dir/$domain.crt" \
        --key-file "$cert_dir/$domain.key" \
        --fullchain-file "$cert_dir/$domain.pem" \
        --ca-file "$cert_dir/$domain.ca"

    # Set permissions
    chmod 600 "$cert_dir/$domain.key"
    chmod 644 "$cert_dir/$domain.crt"
    chmod 644 "$cert_dir/$domain.pem"
    chmod 644 "$cert_dir/$domain.ca"

    # Update Vesta configuration
    update_object_value 'web' 'DOMAIN' "$domain" '$SSL' 'yes'
    update_object_value 'web' 'DOMAIN' "$domain" '$SSL_HOME' "$cert_dir"
    update_object_value 'web' 'DOMAIN' "$domain" '$SSL_CERT' "$domain.crt"
    update_object_value 'web' 'DOMAIN' "$domain" '$SSL_KEY' "$domain.key"
    update_object_value 'web' 'DOMAIN' "$domain" '$SSL_LETSENCRYPT' 'yes'

    # Rebuild web configuration
    $BIN/v-rebuild-web-domains "$user" no

    # Log event
    log_event "$OK" "$ARGUMENTS"

    echo "SSL certificate installed successfully"
    echo "Certificate will auto-renew via cron job"

    # Set up auto-renewal cron job
    cron_cmd="$VESTA/ssl/acme.sh/acme.sh --cron --home $VESTA/ssl/acme.sh"
    if ! crontab -l | grep -q "acme.sh --cron"; then
        (crontab -l 2>/dev/null; echo "0 0 * * * $cron_cmd > /dev/null") | crontab -
        echo "Auto-renewal cron job added"
    fi

else
    echo "ERROR: Failed to obtain SSL certificate"
    echo "Please check:"
    echo "  1. Domain DNS points to this server"
    echo "  2. Port 80 is accessible from internet"
    echo "  3. No firewall blocking HTTP"
    echo "  4. Web server is running"

    log_event "$E_INVALID" "$ARGUMENTS"
    exit $E_INVALID
fi

#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

exit $OK
